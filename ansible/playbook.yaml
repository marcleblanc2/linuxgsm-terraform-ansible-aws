---

- hosts: terraform-ec2-instances
  become: true
  vars_files:
    - ./vars/defaults.yaml
    - ./vars/tf_ansible_vars_file.yaml
  tasks:

  - name: Add i386 arch
    command: dpkg --add-architecture i386
  
  - name: Update package list
    apt:
      update_cache: yes
      cache_valid_time: 3600
  
  - name: Upgrade installed packages
    apt:
      upgrade: full
  
  - name: "Check if SteamCMD is installed"
    package_facts:
      manager: apt

  - name: SteamCMD (licence agreement)
    shell: 
      cmd: echo steam steam/question select "I AGREE" | sudo debconf-set-selections
    when: "'steamcmd:i386' not in ansible_facts.packages"

  - name: SteamCMD (licence note)
    shell: 
      cmd: echo steam steam/license note '' | sudo debconf-set-selections
    when: "'steamcmd:i386' not in ansible_facts.packages"

  - name: Install LGSM dependencies
    apt:
      name: "{{ item }}"
    loop: "{{ lgsm_dependencies }}"

  - name: Ensure LGSM Server Group exists
    group:
      name: "{{ tf_svc_account }}"
      system: yes

  - name: Ensure LGSM Server user exists
    user:
      name: "{{ tf_svc_account }}"
      group: "{{ tf_svc_account }}"
      shell: /bin/bash
      system: yes

  - name: Download LGSM server creator
    get_url:
      url: https://linuxgsm.sh
      dest: "/home/{{ tf_svc_account }}/linuxgsm.sh"
      mode: 0755
      owner: "{{ tf_svc_account }}"

  - name: check if csgoserver file exists
    stat: 
      path: "/home/{{ tf_svc_account }}/csgoserver"
    register: csgoserver_file


### This is where it breaks

  - name: Initialize the csgoserver
    shell: ~/linuxgsm.sh csgoserver
    args:
      executable: /bin/bash
      chdir: "/home/{{ tf_svc_account }}"
    become_user: csgoserver
    register: csgoserver_init
    when: not csgoserver_file.stat.exists

  - debug:
      var: csgoserver_init.stdout_lines
    when: not csgoserver_file.stat.exists

  - name: Installing the csgoserver(this step might take 30-40min)
    shell: ~/csgoserver auto-install > csgoinstall.log
    args:
      executable: /bin/bash
      chdir: "/home/{{ tf_svc_account }}"
    become_user: csgoserver
    when: not csgoserver_file.stat.exists

  - name: Copy server configuration
    copy:
      src: files/server.cfg
      dest: /home/csgoserver/serverfiles/csgo/cfg/csgoserver.cfg
      owner: csgoserver
      group: csgoserver
    register: servercfg

  - name: Copy game configuration
    copy:
      src: files/csgo.cfg
      dest: /home/csgoserver/lgsm/config-lgsm/csgoserver/csgoserver.cfg
      owner: csgoserver
      group: csgoserver
    register: csgocfg

  - name: Restart the server
    become_user: csgoserver
    shell: ~/csgoserver restart
    args:
      executable: /bin/bash
      chdir: "/home/{{ tf_svc_account }}"
    when: servercfg.changed or csgocfg.changed
